version: 2.1
jobs:
  tfsec_tests:
    docker:
      - image: aquasec/tfsec:latest
    working_directory: /project  # Установите рабочий каталог в контейнере
    steps:
      - checkout
      - run:
          name: "Install Git and SSH"
          command: |
            sudo apt-get update
            sudo apt-get install git
            sudo apt-get install ssh
          name: "Run tfsec"
          command: tfsec . --format=json
          
  terraform_init:
    docker:
      - image: hashicorp/terraform:latest
    steps:
      - checkout
      - run: terraform init

  terraform_validate_and_plan:
    docker:
      - image: hashicorp/terraform:latest
    steps:
      - checkout
      - run: terraform validate
      - run: terraform plan -out=tfplan
      # Добавьте здесь логику ожидания утверждения через API CircleCI

  terraform_apply:
    docker:
      - image: hashicorp/terraform:latest
    steps:
      - checkout
      - run: terraform apply "tfplan"

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - tfsec_tests
      - terraform_init
      - terraform_validate_and_plan:
          requires:
            - tfsec_tests
            - terraform_init
      - terraform_apply:
          requires:
            - terraform_validate_and_plan
