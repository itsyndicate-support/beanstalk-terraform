version: 2.1

executors:
  tfsec-executor:
    docker:
      - image: aquasec/tfsec:latest
        environment:
          TF_SEC_DIR: /tmp/project
    working_directory: /tmp/project

  terraform-executor: 
    docker:
      - image: hashicorp/terraform:latest 
    working_directory: /tmp/project

jobs:
  tfsec-test:
    executor: tfsec-executor
    steps:
      - checkout
      - run:
          name: Run tfsec tests
          command: tfsec . --format-json

  terraform-init:
    executor: terraform-executor
    steps:
      - checkout
      - run:
          name: Terraform init
          command: terraform init

  terraform-validate-plan:
    executor: terraform-executor
    steps:
      - checkout
      - run:
          name: Terraform validate and plan
          command: |
            terraform validate
            terraform plan

  hold-for-approval-1:
    executor: tfsec-executor
    steps:
      - checkout
      - run:
          name: Hold for approval
          command: echo "Hold for approval. Approve in CircleCI dashboard to continue."

  terraform-apply:
    executor: terraform-executor
    steps:
      - checkout
      - run:
          name: Terraform apply
          command: terraform apply -auto-approve

  infrastructure-tests:
    executor: tfsec-executor
    steps:
      - checkout
      - run:
          name: Infrastructure tests
          command: echo "Your infrastructure tests command here"

  hold-for-approval-2:
    executor: tfsec-executor
    steps:
      - checkout
      - run:
          name: Hold for approval
          command: echo "Hold for approval. Approve in CircleCI dashboard to continue."

workflows:
  version: 2
  build-deploy:
    jobs:
      - tfsec-test
      - terraform-init
      - terraform-validate-plan
      - hold-for-approval-1:
          type: approval
      - terraform-apply:
          requires:
            - hold-for-approval-1
      - infrastructure-tests:
          requires:
            - terraform-apply
      - hold-for-approval-2:
          type: approval
