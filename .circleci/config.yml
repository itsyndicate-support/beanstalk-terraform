version: 2.1
jobs:
  pre-test:
    resource_class: ewsaxyfkcp5g9tbybh5unx/k8stest
    executor: tfsec/default
    steps:
      - checkout
      - tfsec/scan:
          directory: ./infrastructure
  post-test:
    resource_class: ewsaxyfkcp5g9tbybh5unx/k8stest
    executor:
      name: go/default
      tag: '1.18'
    docker:
      - image: ivanopulo/terratest:0.0.4
    steps:
      - run:
          name: terratest
          command: |
            go test ./terratest/test/main.go

workflows:
  version: 2
  plan_approve_apply:
    jobs:
      - pre-test
      - post-test:
          requires:
            - pre-tests
