version: 2.1
jobs:
  tfsec_tests:
    docker:
      - image: tfsec/tfsec:latest
    steps:
      - checkout
      - run: tfsec .

  terraform_init:
    docker:
      - image: hashicorp/terraform:latest
    steps:
      - checkout
      - run: terraform init

  terraform_validate_and_plan:
    docker:
      - image: hashicorp/terraform:latest
    steps:
      - checkout
      - run: terraform validate
      - run: terraform plan -out=tfplan
      - hold:
          name: "hold"
          type: approval
          requires:
            - tfsec_tests
            - terraform_init
      - run: terraform apply "tfplan"

workflows:
  build-and-deploy:
    jobs:
      - tfsec_tests
      - terraform_init
      - terraform_validate_and_plan
