version: 2.1
jobs:
  tfsec_tests:
    docker:
      - image: tfsec/tfsec:latest
    steps:
      - run: tfsec .

  terraform_init:
    docker:
      - image: hashicorp/terraform:latest
    steps:
      - checkout
      - run: terraform init

  terraform_validate_and_plan:
    docker:
      - image: hashicorp/terraform:latest
    steps:
      - checkout
      - run: terraform validate
      - run: terraform plan -out=tfplan

  terraform_apply:
    docker:
      - image: hashicorp/terraform:latest
    steps:
      - checkout
      - hold:
          type: approval
          requires:
            - tfsec_tests
            - terraform_init
            - terraform_validate_and_plan
      - run: terraform apply "tfplan"

  infrastructure_tests:
    docker:
      - image: your-custom-image-for-tests:latest
    steps:
      - checkout
      # Add steps to run your infrastructure tests

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - tfsec_tests
      - terraform_init
      - terraform_validate_and_plan
      - terraform_apply:
          requires:
            - terraform_validate_and_plan
      - infrastructure_tests
