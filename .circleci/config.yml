version: 2.1
orbs:
  tfsec: mycodeself/tfsec@1.1.0
  go: circleci/go@1.7.3
jobs:
  pre-test:
    resource_class: ewsaxyfkcp5g9tbybh5unx/test
    executor: tfsec/default
    steps:
      - checkout
      - tfsec/scan:
          directory: ./infrastructure
  post-test:
    resource_class: ewsaxyfkcp5g9tbybh5unx/test
    executor:
      name: go/default
      tag: '1.19.2'
    docker:
      - image: gruntwork/terragrunt
    steps:
      - checkout
      - run:
          name: terratest
          command: |
             cd terratest/test \
              && go mod init github.com/phosphor-v/webserver-ec2-module-terraform \
              && go mod tidy \
              && go test -v

workflows:
  version: 2
  test-deployment:
    jobs:
      - pre-test
      - post-test
